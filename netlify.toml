[build]
  command = "pnpm install --frozen-lockfile && pnpm run prisma:generate && pnpm run build"
  publish = ".next"

[build.environment]
  NODE_VERSION = "20"
  NEXT_PRIVATE_SKIP_VALIDATION = "1"
  PNPM_VERSION = "9"
  SECRETS_SCAN_ENABLED = "false"

# Plugin Next.js (necessário)
[[plugins]]
  package = "@netlify/plugin-nextjs"

# NOTA: Headers agora são definidos em public/_headers
# para melhor controle do CSP e evitar conflitos

# Redirects
[[redirects]]
  from = "/health"
  to = "/api/health"
  status = 200

[[redirects]]
  from = "/admin"
  to = "/dashboard"
  status = 301

# Função serverless timeout
[functions]
  node_bundler = "esbuild"
  # Timeout padrão estendido para uploads
  included_files = ["prisma/schema.prisma"]

# Configuração específica para upload de mídia
[[functions]]
  # Next.js API routes seguem padrão .netlify/functions/
  # Mas usamos glob pattern para identificar
  path = "api/clients/*/media/upload"
  node_bundler = "esbuild"
  # Timeout máximo para uploads grandes
  timeout = 300
  # Memória extra para sharp/compressão
  memory = 3008
  
[functions."api/*"]
  node_bundler = "esbuild"
